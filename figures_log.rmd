---
title: "R Notebook"
output: html_notebook
---

```{r setup,include=F}
knitr::opts_chunk$set(fig.asp=0.618)

library(magrittr)
library(CellaRepertorium)
library(immunarch)
library(tidyverse)

rep4 <- readRDS('data_misc/rep4.rds')
cella <- readRDS('data_misc/cella4.rds')
cl <- readRDS('data_misc/clinical.rds')
# dat <- readRDS('data_sc/meta_ldat.rds') %>% 
dat <- readRDS('data_sc/meta_tc.rds') %>% 
  mutate(patient=case_when(
    str_starts(orig.ident,'P')~str_extract(orig.ident,'(?<=PEM)\\d+'),
    str_starts(orig.ident,'eric')~orig.ident,
    orig.ident=='HD1'~'HA5876',orig.ident=='HD2'~'HA5877',
    orig.ident=='HD3'~'HA5894',orig.ident=='HD4'~'HA5952',
    orig.ident=='HD5'~'HA5953',orig.ident=='HD6'~'HA5957',
    T~NA_character_))

add_clinical <- function(df,patient_col='patient'){
  p1 <- df[[patient_col]]
  df$clinical <- case_when(
    p1=='healthy'~'Healthy',
    p1 %in% c('14','25','5','2','6','23')~'Lynch-like responder',
    p1 %in% c('18','19','22','20','12','11','13')~'Nonlynch-like responder',
    p1 %in% c('1','3','7','8','9','10','15','16','17','21','24','26')~'Nonresponder',
    stringr::str_starts(p1,'(HD)|(HA)|(eric)')~'Healthy',
    T~NA_character_)
  if(any(is.na(df$clinical))) warning('invalid patient code')
  df
}
cella@contig_tbl %<>% add_clinical()
cella@cell_tbl %<>% add_clinical()

plotBoxplot <- function(df,value_col='Value'){
  df$Value <- df[[value_col]]
  ggplot(df,aes(clinical,Value,fill=clinical))+
    geom_boxplot(outlier.alpha=0)+geom_jitter(width=0.05,height=0)
}

cols_clinical <- c('Lynch-like responder'='#D25B3F','Nonlynch-like responder'='#356870','Nonresponder'='#8D7233','Healthy'='#3C367E')
cols_clinical_dark <- colorspace::darken(cols_clinical,0.6) %>% set_names(c('Lynch-like responder','Nonlynch-like responder','Nonresponder','Healthy'))
prism <- function(gg){
  gg+theme_prism()+scale_fill_manual(values=cols_clinical)+
  scale_color_manual(values=cols_clinical_dark)
}
```

## Misc exploratory T cell

### overall overlap
```{r TIL overlap timepoints}
# til overlap timepoints
repOverlap(rep4$data[rep4$meta$timepoint %in% c('0','7')],'jaccard') %>% 
  vis('heatmap2')
# maybe try and find corr between 0-7 similarity and 1-5 similarity or like yeah
```
the pre-post tils always strong cluster in overlap/jaccard/morisita
26/9/3/12 consistent, 19 and 7 iffy (7 really low counts)

```{r PBMC overlap timepoints}
repOverlap(rep4$data[rep4$meta$timepoint %in% c('1','3','5')],'morisita') %>% 
  vis('heatmap2')
```
morisita looks beautiful, all patients cluster really strongly
some mixing with the low 20's in jaccard and overlap, but overall very strong

```{r overall overlap}
repOverlap(rep4$data,'overlap') %>% vis('heatmap2')
```
overlap is nearly perfect (just 3til and 3pbmc separate but still have an island of overlap out there), jaccard good but mixes some up, morisita segregates like all the til from nontil

```{r pbmc-til overlap}
h1 <- repOverlap(rep4$data,'jaccard') %>% as.data.frame() %>% rownames_to_column('temp') %>% pivot_longer(-temp) %>% separate(temp,c('p1','t1'),'-') %>% separate(name,c('p2','t2'),'-') %>% na.omit() %>% filter(p1==p2,t1 %in% c('0','7'),t2 %in% c('1','3','5'))
# boxplot of TIL overlap at each timepoint
ggplot(filter(h1,t1=='0'),aes(t2,value))+geom_boxplot(outlier.alpha=0)+geom_jitter(width=0.05,height=0)
ggplot(filter(h1,t1=='0') %>% add_clinical('p1'),aes(t2,value,fill=clinical))+
  geom_boxplot()
# boxplot of TIL overlap at each timepoint (post TIL)
ggplot(filter(h1,t1=='7'),aes(t2,value))+geom_boxplot(outlier.alpha=0)+geom_jitter(width=0.05,height=0)
```
looks like generally stronger 5-7 overlap (but small and not much for any other)

```{r temporal change in pbmc-til overlap} 
filter(h1,t1=='0',t2!='3') %>% pivot_wider(id_cols=p1,names_from=t2,values_from=value) %>% 
  na.omit() %>% mutate(value=`5`-`1`) %>% # this is only 5-1 diff
  add_clinical('p1') %>% 
  ggplot(aes(reorder(p1,desc(value)),value,fill=clinical))+geom_col()
# proportional change, 23/20 outliers removed
filter(h1,t1=='0',t2!='3',!(p1 %in% c('23','20'))) %>% pivot_wider(id_cols=p1,names_from=t2,values_from=value) %>% 
  na.omit() %>% mutate(value=(`5`-`1`)/`1`) %>% # this is only 5-1 diff
  add_clinical('p1') %>% 
  ggplot(aes(reorder(p1,desc(value)),value,fill=clinical))+geom_col()
```
the questionable data shows enrichment towards both extremes
with outliers removed though, it looks like just increase in TM overlap for NLR

```{r quantitative 1-5 change in til overlap}
rbind(
  filter(h1,p1 %in% unique(h1$p1)[map_lgl(unique(h1$p1),~all(c('1','5') %in% filter(h1,p1==.x)$t2))],t1=='0') %>% pivot_wider(names_from=t2,values_from=value) %>% mutate(value=`5`-`1`),
  filter(h1,p1 %in% unique(h1$p1)[map_lgl(unique(h1$p1),~all(c('1','5') %in% filter(h1,p1==.x)$t2))],t1=='7') %>% pivot_wider(names_from=t2,values_from=value) %>% mutate(value=`5`-`1`)) %>% 
  ggplot(aes(t1,value,fill=t1))+geom_boxplot(outlier.alpha=0)+
  geom_jitter(width=0.05,height=0)
```
it kinda looked like something was there, but looks inconclusive

```{r proportion clones TM}
h1 <- rep4$data[(rep4$meta$timepoint %in% c(1,3,5))&
                  (!(names(rep4$data) %in% c('20-5','23-1')))]
h1 <- map_dbl(h1,~mean(!is.na(.x$expTil))) %>% 
  set_names(names(h1)) %>% data.frame('prop'=`.`) %>%
  rownames_to_column() %>% separate(rowname,c('patient','timepoint')) %>% 
  add_clinical()
plotBoxplot(h1,'prop')
plotBoxplot(h1,'prop')+facet_wrap(~timepoint)
map(c(1,3,5),function(x){
  ggplot(h1[h1$timepoint==x,],aes(reorder(patient,desc(prop)),
                                  prop,fill=clinical))+geom_col()})

# temporal change
h1 <- pivot_wider(h1,id_cols=patient,names_from=timepoint,values_from=prop) %>% 
  mutate(`3-1`=(`3`-`1`)/`1`,`5-1`=(`5`-`1`)/`1`,`5-3`=(`5`-`3`)/`3`) %>% 
  add_clinical()
plotBoxplot(h1,'5-1')
filter(h1,!is.na(`5-1`)) %>% 
  ggplot(aes(reorder(patient,desc(`5-1`)),`5-1`,fill=clinical))+geom_col()
```
Lynch has higher prop of clones TM, decreases over time

```{r proportion seqs TM}
h1 <- rep4$data[(rep4$meta$timepoint %in% c(1,3,5))&
                  (!(names(rep4$data) %in% c('20-5','23-1')))]
h1 <- map_dbl(h1,~sum(.x$Clones[!is.na(.x$expTil)])/sum(.x$Clones)) %>%
  set_names(names(h1)) %>% data.frame('prop'=`.`) %>%
  rownames_to_column() %>% separate(rowname,c('patient','timepoint')) %>% 
  add_clinical()
plotBoxplot(h1,'prop')
plotBoxplot(h1,'prop')+facet_wrap(~timepoint)
map(c(1,3,5),function(x){
  ggplot(h1[h1$timepoint==x,],aes(reorder(patient,desc(prop)),
                                  prop,fill=clinical))+geom_col()})

# temporal change
h1 <- pivot_wider(h1,id_cols=patient,names_from=timepoint,values_from=prop) %>% 
  mutate(`3-1`=(`3`-`1`)/`1`,`5-1`=(`5`-`1`)/`1`,`5-3`=(`5`-`3`)/`3`) %>% 
  add_clinical()
plotBoxplot(h1,'5-1')
filter(h1,!is.na(`5-1`)) %>% 
  ggplot(aes(reorder(patient,desc(`5-1`)),`5-1`,fill=clinical))+geom_col()
```
lynch highest prop TM, NLR second
NLR is a lot more TM porpotion increase while others decrease
But none of this translates to any pattern in change in TM clonality
this could also be the result of sample size of pbmc and til - manual jaccard is better?


## T cell prognostic

## Lynch-like subgroup