sep='_')
dat1@contig_tbl$combined <-
paste(dat1@contig_tbl$barcode,
dat1@contig_tbl$patient %>% str_replace('^[a-zA-Z].*','healthy'),
tidyr::replace_na(dat1$contig_tbl$timepoint,''),
sep='_')
dat1
}
dat <- readRDS('data_misc/dat_healthy.rds')
install.packages('devtools')
install.packages('Seurat')
install.packages('tidyverse')
pacman::p_install(c('magrittr','CellaRepertorium','pheatmap','cowplot','gridExtra'))
pacman::p_install('BiocManager','SingleR')
pacman::p_install(c('BiocManager','SingleR'))
install.packages('BiocManager')
BiocManager::install('CellaRepertorium')
BiocManager::install('SingleR')
BiocManager::install('SingleCellExperiment')
devtools::install_github("immunomind/immunarch", ref="dev")
devtools::install_github("immunomind/immunarch", ref="dev")
immunarch
devtools::install_github("immunomind/immunarch", ref="dev")
library(Seurat)
install.packages('monocle3')
BiocManager::install('monocle')
library('monocle')
library(monocle)
?clusterCall
?clusterCells
BiocManager::install('monocle3')
devtools::install_github('immunomind/immunarch',ref='dev')
immunarch::vis()
?immunarch::vis()
stringr::str_replace_all('CD8 Exhausted Progenitor',' ','_')
for(i in 1:3) i
for(i in 1:3) print(i)
library(tidyverse)
library(Seurat)
library(immunarch)
library(CellaRepertorium)
?CellaRepertorium::canonicalize_cell
devtools::install_github("gadenbuie/rsthemes")
devtools::install_github("gadenbuie/rsthemes")
rsthemes::try_rsthemes()
rsthemes::install_rsthemes()
rsthemes::list_rsthemes()
rsthemes::try_rsthemes()
rstudioapi::applyTheme('Material  Ocean {rsthemes}')
rstudioapi::applyTheme('Material Ocean {rsthemes}')
?png
library(magrittr)
library(tidyverse)
library(CellaRepertorium)
library(magrittr)
library(CellaRepertorium)
library(immunarch)
library(tidyverse)
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
cl <- readRDS('data_misc/clinical.rds')
# setup
dat@contig_tbl$expTil <- 0
dat@contig_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
dat@cell_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
# add expPbmc (all clones get same number, ie: all 80 matching contigs have expPbmc=80)
dat@contig_tbl %<>% add_count(patient,timepoint,chain,cdr3,name='expPbmc')
rep1$data <- map(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
})
rep1 <- readRDS('data_misc/rep1.rds')
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
})
h1
h1$patient
h1$patient %>% unique()
object.size(h1)
names(h1)
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,name=expTil)
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,name='expTil')
names(h1)
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil)
filter(h1,patient=='1',timepoint=='1')$expTil %>% table()
filter(h1,patient=='1',timepoint=='1)
filter(h1,patient=='1',timepoint=='1')
# add exptil to tils
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil)
h1
filter(h1,timepoint=='0',patient=='o')$expTil %>% table()
filter(h1,timepoint=='0',patient=='1')$expTil %>% table()
filter(h1,timepoint=='0',patient=='1')$expTil %>% unique()
rep1$data$`1-0`$Clones %>% unique() %>% sort(decreasing=T)
sum(rep1$data$`1-0`$CDR3.aa %>% duplicated())
nrow(rep1$data$`1-0`$CDR3.aa)
length(rep1$data$`1-0`$CDR3.aa)
# setup
dat@contig_tbl$expTil <- c()
# setup
dat@contig_tbl$expTil <- c()
# add exppbmc to tils
left_join(dat@contig_tbl,h1,by=c('patient'='patient','timepoint'='timepoint','cdr3'='CDR3.aa'))
# add exppbmc to tils
left_join(dat@contig_tbl,h1,by=c('patient'='patient','timepoint'='timepoint','cdr3'='CDR3.aa')) %>% .$expTil
# add exppbmc to tils
left_join(dat@contig_tbl,h1,by=c('patient'='patient','timepoint'='timepoint','cdr3'='CDR3.aa')) %>% .$expTil %>% unique()
unique(h1$patient)
unique(h1$timepoint)
# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa'))
# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% .$expTil
# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% .$expTil %>% unique()
# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% .$expTil %>% table()
sum((# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% .$expTil)>0)
sum((# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% .$expTil)>0,na.rm=T)
filter(h1,timepoint=='7') %>% rename(expPost=expTil)
# add exppbmc to tils
left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil),
by=c('patient'='patient','cdr3'='CDR3.aa'))
# add exppbmc to tils
dat@contig_tbl <- left_join(dat@contig_tbl,filter(h1,timepoint=='0'),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil),
by=c('patient'='patient','cdr3'='CDR3.aa'))
rsthemes::try_rsthemes()
dat
dat@contig_tbl %>% names()
# setup
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
dat@contig_tbl$expTil <- c()
dat@contig_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
dat@cell_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
# add expPbmc to dat (all clones get same number, ie: all 80 matching contigs have expPbmc=80)
dat@contig_tbl %<>% add_count(patient,timepoint,chain,cdr3,name='expPbmc')
# add exptil to tils
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil)
h1
left_join(dat@contig_tbl,
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
h2 <- left_join(dat@contig_tbl,
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
names(h2)
table(h2$expPost)
table(h2$expTil)
table(h2$expPbmc)
# add expTils to pbmc
dat@contig_tbl <- left_join(dat@contig_tbl,
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
rm(h2)
rm(h1)
sum(dat@contig_tbl %>% filter(chain=='TRB') %>% select(barcode,patient,timepoint) %>% duplicated())
(dat@contig_tbl %>% filter(chain=='TRB') %>% select(barcode,patient,timepoint) %>% nrow())
# setup
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
dat@contig_tbl$expTil <- c()
dat@contig_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
dat@cell_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
# add expPbmc to dat (all clones get same number, ie: all 80 matching contigs have expPbmc=80)
dat@contig_tbl %<>% add_count(patient,timepoint,chain,cdr3,name='expPbmc')
# create df of seqs and expTil
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil)
# add expTil and expPost to pbmc
h1 <- left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
nrow(h1)
nrow(dat@contig_tbl)
nrow(dat@contig_tbl %>% filter(chain=='TRA'))
180264+219111
nrow(dat@contig_tbl %>% filter(chain=='TRB'))
# create df of seqs and expTil
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil)
nrow(h1)
head(h1)
filter(dat@contig_tbl,chain=='TRB') %>% nrow()
left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% nrow()
left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
h1
duplicated(h1)
any(duplicated(h1))
h1
unique(h1)
unique(h1) %>% select(-expTil) %>% duplicated()
any(unique(h1) %>% select(-expTil) %>% duplicated())
# create df of seqs and expTil
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil) %>%
unique() #add_count leaves the duplicated in, need to remove
any(unique(h1) %>% select(-expTil) %>% duplicated())
any(h1 %>% select(-expTil) %>% duplicated())
left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% nrow()
filter(dat@contig_tbl,chain=='TRB') %>% nrow()
left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>% nrow()
# add expTil and expPost to pbmc
h1 <- left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
sum(dat@contig_tbl$chain=='TRB')
sum(dat@contig_tbl$chain=='TRA')
nrow(dat@contig_tbl)
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_character_,expPost=NA_character_),
h1)
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_character_,expPost=NA_character_),
h1) %>% .$expTil
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_character_,expPost=NA_character_),
h1) %>% .$expTil %>% unique()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% nrow()
nrow(dat@contig_tbl)
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% unique()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% table()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% is.na() %>% sum()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% !is.na(.) %>% sum()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% is.na() %>% !. %>% sum()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% is.na() %>% negate() %>% sum()
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% is.na() %>% negate()
?negate
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% negate(is.na)
rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1) %>% .$expTil %>% negate(~is.na(.x))
dat@contig_tbl <- rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1)
rm(h1)
nrow(dat@contig_tbl)
sum(!is.na(dat@contig_tbl$expTil))
sum(!is.na(dat@contig_tbl$expPost))
unique(dat@contig_tbl$expTil)
unique(dat@contig_tbl$expTil[dat@contig_tbl$chain=='TRB'])
sum(is.na(dat@contig_tbl$expTil[dat@contig_tbl$chain=='TRB']))
sum(!is.na(dat@contig_tbl$expTil[dat@contig_tbl$chain=='TRB']))
sum(dat@contig_tbl$chain=='TRB')
sum(!is.na(dat@contig_tbl$expPost[dat@contig_tbl$chain=='TRB']))
unique(dat@contig_tbl$patient[!is.na(dat@contig_tbl$expPost)])
unique(dat@contig_tbl$patient)
nrow(dat@contig_tbl %>% filter(chain=='TRB',patient %in% c('12','9','3','7','8','9')))
8018/42018
42018/199005
dat@contig_tbl %>% names()
?canonicalize_cell
dat@cell_tbl %>% names()
# map contig characteristics to cells
# have 28634 duplicate contigs - up to that many cells with mult TRB
canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys=c('expPbmc','expPost','expTil','umis'),
contig_fields=c('cdr3','cdr3_nt','v_gene','d_gene',
'j_gene','c_gene'))
h1 <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys=c('expPbmc','expPost','expTil','umis'),
contig_fields=c('cdr3','cdr3_nt','v_gene','d_gene',
'j_gene','c_gene'))
h1@cell_tbl %>% names()
dat@cell_tbl$expTil <- c()
dat@cell_tbl$expPbmc <- c()
h1@cell_tbl$v_gene
nrow(h1@cell_tbl)
nrow(dat@cell_tbl)
h1@cell_tbl$v_gene %>% unique()
sum(!is.na(h1@cell_tbl$cdr3))
sum(is.na(h1@cell_tbl$cdr3))
# map contig characteristics to cells
# have 28634 duplicate contigs - up to that many cells with mult TRB
# only mapping contig chars, sort by expPbmc more accurate to represent cdr3
dat <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys=c('expPbmc','expPost','expTil','umis'),
contig_fields=c('cdr3','cdr3_nt','v_gene','d_gene',
'j_gene','c_gene'))
dat
library(magrittr)
library(CellaRepertorium)
library(immunarch)
library(tidyverse)
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
cl <- readRDS('data_misc/clinical.rds')
# setup
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
dat@contig_tbl$expTil <- c()
dat@contig_tbl$expPbmc <- c()
dat@cell_tbl$expTil <- c()
dat@cell_tbl$expPbmc <- c()
dat@contig_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
dat@cell_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
# add expPbmc to dat (all clones get same number, ie: all 80 matching contigs have expPbmc=80)
dat@contig_tbl %<>% add_count(patient,timepoint,chain,cdr3,name='expPbmc')
# create df of seqs and expTil
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil) %>%
unique() #add_count leaves the duplicated in, need to remove
# add expTil and expPost to pbmc
h1 <- left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
dat@contig_tbl <- rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1)
rm(h1) #42018/199005 TRBs have expTil, 8018/42589 TRB have expPost
h1 <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys=c('expPbmc','umis'),
contig_fields=c('cdr3','cdr3_nt','v_gene','d_gene',
'j_gene','c_gene','expPbmc'))
h1
h1@contig_tbl==dat@contig_tbl
all(h1@contig_tbl==dat@contig_tbl,na.rm=T)
all(h1@cell_tbl==dat@cell_tbl,na.rm=T)
names(dat@cell_tbl)
all(select(h1@cell_tbl,barcode,patient,timepoint)==dat@cell_tbl,na.rm=T)
nrow(h1@cell_tbl)
nrow(dat@cell_tbl)
all(h1@cell_tbl$barcode %in% dat@cell_tbl$barcode)
all(h1@cell_tbl$patient %in% dat@cell_tbl$patient)
table(h1@cell_tbl$barcode)
all(sort(table(h1@cell_tbl$barcode))==sort(table(dat@cell_tbl$barcode))  )
dat@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint)
dat@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint)
dat@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint,cdr3)
(dat@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcodesum,timepoint,cdr3) %>% duplicated())
sum(dat@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint,cdr3) %>% duplicated())
sum(dat@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint) %>% duplicated())
h2 <- readRDS('data_misc/dat_healthy.rds')
sum(h2@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint) %>% duplicated())
rm(h2)
h1
sum(h2@contig_tbl %>% select(patient,barcode,timepoint) %>% duplicated())
sum(h1)
sum(h1@contig_tbl %>% select(patient,barcode,timepoint) %>% duplicated())
sum(h1@contig_tbl %>% filter(chain=='TRB') %>% select(patient,barcode,timepoint) %>% duplicated())
select(h1@contig_tbl,barcode,patient,timepoint,cdr3)
select(h1@cell_tbl,barcode,patient,timepoint,cdr3)
select(h1@contig_tbl %>% filter(chain=='TRB'),barcode,patient,timepoint,cdr3)
select(h1@contig_tbl %>% filter(chain=='TRB'),barcode,patient,timepoint,cdr3)
?semi_join()
anti_join(select(h1@contig_tbl %>% filter(chain=='TRB'),barcode,patient,timepoint,cdr3),
select(h1@cell_tbl,barcode,patient,timepoint,cdr3))
anti_join(filter(h1@contig_tbl,chain=='TRB'),
h1@cell_tbl,by=c('patient','timepoint','cdr3','barcode'))
anti_join(filter(h1@contig_tbl,chain=='TRB'),
h1@cell_tbl,by=c('patient','timepoint','cdr3','barcode')) %>% .$expPbmc
anti_join(filter(h1@contig_tbl,chain=='TRB'),
h1@cell_tbl,by=c('patient','timepoint','cdr3','barcode')) %>% .$expPbmc %>% table()
anti_join(filter(h1@contig_tbl,chain=='TRB'),
h1@cell_tbl,by=c('patient','timepoint','cdr3','barcode')) %>% filter(expPbmc=503)
anti_join(filter(h1@contig_tbl,chain=='TRB'),
h1@cell_tbl,by=c('patient','timepoint','cdr3','barcode')) %>% filter(expPbmc==503)
h2 <- anti_join(filter(h1@contig_tbl,chain=='TRB'),
h1@cell_tbl,by=c('patient','timepoint','cdr3','barcode')) %>% filter(expPbmc==503)
h1@contig_tbl %>% filter(patient==h2$patient,timepoint==h2$timepoint,barcode==h2$barcode)
h1@contig_tbl %>% filter(patient==h2$patient,timepoint==h2$timepoint,barcode==h2$barcode,chain=='TRB') %>% .$expPbmc
#190477 have cdr3 - all of them with TRB contigs
# add expansion annotations to cells
# canonicalize doesn't necessarily retain highest exptil/post since sort by pbmc
dat <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys='expTil',contig_fields='expTil')
dat <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys='expPost',contig_fields='expPost')
dat@cell_tbl %>% names()
# setup
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
dat@contig_tbl$expTil <- c()
dat@contig_tbl$expPbmc <- c()
dat@cell_tbl$expTil <- c()
dat@cell_tbl$expPbmc <- c()
dat@contig_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
dat@cell_tbl %<>% mutate(timepoint=replace_na(timepoint,'h'))
# add expPbmc to dat (all clones get same number, ie: all 80 matching contigs have expPbmc=80)
dat@contig_tbl %<>% add_count(patient,timepoint,chain,cdr3,name='expPbmc')
# create df of seqs and expTil
h1 <- map_dfr(names(rep1$data),function(x){
rep1$data[[x]] %>% mutate(patient=str_extract(x,'.*(?=-)'),
timepoint=str_extract(x,'.$'))
}) %>% add_count(patient,timepoint,CDR3.aa,wt=Clones,name='expTil') %>%
select(CDR3.aa,patient,timepoint,expTil) %>%
unique() #add_count leaves the duplicated in, need to remove
# add expTil and expPost to pbmc
h1 <- left_join(filter(dat@contig_tbl,chain=='TRB'),
filter(h1,timepoint=='0') %>% select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa')) %>%
left_join(filter(h1,timepoint=='7') %>% rename(expPost=expTil) %>%
select(-timepoint),
by=c('patient'='patient','cdr3'='CDR3.aa'))
dat@contig_tbl <- rbind(filter(dat@contig_tbl,chain=='TRA') %>%
mutate(expTil=NA_integer_,expPost=NA_integer_),
h1)
rm(h1) #42018/199005 TRBs have expTil, 8018/42589 TRB have expPost
# map contig characteristics to cells
# have 28634 duplicate contigs - up to that many cells with mult TRB
# only mapping contig chars, sort by expPbmc more accurate to represent cdr3
dat <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys=c('expPbmc','umis'),
contig_fields=c('cdr3','cdr3_nt','v_gene','d_gene',
'j_gene','c_gene','expPbmc'))
#190477 have cdr3 - all of them with TRB contigs
# add expansion annotations to cells
# canonicalize doesn't necessarily retain highest exptil/post since sort by pbmc
dat <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys='expTil',contig_fields='expTil')
dat <- canonicalize_cell(dat,contig_filter_args=chain=='TRB',
tie_break_keys='expPost',contig_fields='expPost')
nrow(dat@cell_tbl)
h1 <- readRDS('data_misc/dat_healthy.rds')
nrow(h1@cell_tbl)
rm(h1)
names(dat@cell_tbl)
any(select(dat@cell_tbl,barcode,patient,timepoint) %>% duplicated())
length(group_split(dat@contig_tbl,patient,timepoint))
length(unique(interaction(dat@contig_tbl$patient,dat@contig_tbl$timepoint)))
?count
names(dat@contig_tbl)
