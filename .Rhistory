seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
# w <- ((dat@cell_tbl$barcode %in% bars)&
#   (dat@cell_tbl$patient==p)&
#   (dat@cell_tbl$timepoint==tp))
dat@cell_tbl$expTil[((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))] <- i
})
})
})
unique(dat@cell_tbl$expTil)
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
dat@cell_tbl$expTil[w] <- i
})
})
})
unique(dat@cell_tbl$expTil)
data.frame('a'=1:4,'b'=2:5)
h1 <- data.frame('a'=1:4,'b'=2:5)
h1
filter(h1,a>1)
filter(h1,a>1)$b
filter(h1,a>1)$b <- NA
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
length(w)
# dat@cell_tbl$expTil[w] <- i
})
})
})
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
length(w) %>% print()
# dat@cell_tbl$expTil[w] <- i
})
})
})
nrow(dat@cell_tbl)
length(dat@cell_tbl$expTil)
unique(dat@cell_tbl$expTil)
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
print(i)
# dat@cell_tbl$expTil[w] <- i
})
})
})
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
length(dat@cell_tbl$expTil[w]) %>% print()
})
})
})
str(dat@cell_tbl$expTil)
class(c(1,2,8))
dat@cell_tbl$expTil[c(T,F)] <- 1
dat@cell_tbl$expTil
# annotate
dat@cell_tbl$expTil <- 0
# annotate
dat@cell_tbl$expTil <- 0
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
dat@cell_tbl[w,'expTil'] <- i
})
})
})
unique(dat@cell_tbl$expTil)
h1
map(withTils,function(p){
map(c(1,2,8),function(i){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint %>%
map(function(tp){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
w <- ((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))
dat@cell_tbl[w,'expTil'] <- i
h1[1,1] <- NA
})
})
})
h1
# annotate
dat@cell_tbl$expTil <- 0
for(p in withTils){
for(i in c(1,2,8)){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
for(tp in rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
dat@cell_tbl$expTil[((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))] <- i
}
}
}
unique(dat@cell_tbl$expTil)
table(dat@cell_tbl$expTil)
saveRDS(dat,'data_misc/dat.rds')
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3]) %>%
set_rownames(p)
})
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
})
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% pivot_longer(c('singlet','mid','expanded'))
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
ggplot(aes(patient,value,fill=name))+geom_col()
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='fill')
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
})
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='fill')
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total))
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total)) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
ggplot(aes(patient,value,fill=name))+geom_col()
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total)) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='dodge')
ggplot(aes(patient,value,fill=name))+geom_col(position='dodge')
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total)) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
filter(name=='expanded') %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='dodge')
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total)) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
filter(name=='mid') %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='dodge')
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total)) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
filter(name=='singlet') %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='dodge')
# quant per til
map_dfr(withTils,function(p){
temp1 <- map_dbl(c(1,2,8),function(i){
rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% nrow()
})
temp1[1] <- temp1[1]-temp1[2]
temp1[2] <- temp1[2]-temp1[3]
data.frame('patient'=p,'singlet'=temp1[1],'mid'=temp1[2],'expanded'=temp1[3])
}) %>% mutate(total=singlet+mid+expanded) %>%
mutate(across(c(expanded,mid,singlet),~.x/total)) %>%
pivot_longer(c('singlet','mid','expanded')) %>%
arrange(patient) %>% mutate(patient=as.factor(patient)) %>%
filter(name=='expanded') %>%
ggplot(aes(patient,value,fill=name))+geom_col(position='dodge')
library(magrittr)
library(tidyverse)
allMark <- readRDS('data_sc/tc_allmark.rds')
topMark <- map(group_split(allMark,cluster),~arrange(.x,desc(avg_log2FC)) %>% .[1,]) %>%
set_names(group_by(allMark,cluster) %>% group_keys() %>% unlist()) %>%
map_dfr(~.x)
source('../rig-i/panglao.r')
panglao2 <- function(clust){
allMark %>% filter(cluster==clust) %>% arrange(desc(avg_log2FC)) %>%
.$gene %>% .[1:10] %>%
panglaoMain()
}
mark <- map(list.files('data_sc/mark_tc/'), function(p){
p2 <- paste0('data_sc/mark_tc/',p)
readRDS(p2)
})
# mark %<>% set_names(paste0('c', list.files('data_sc/mark/') %>%
# str_extract('\\d+')))
mark %<>% set_names(paste0('c', list.files('data_sc/mark_tc/') %>%
str_extract('(?<=mark_)\\d+')))
sf2 <- function(gene){
gene <-
colnames(scaled)[str_detect(colnames(scaled),gene)]
}
scaled <- readRDS('data_sc/tc_scaled.rds') %>%
t() %>% as.data.frame()
dev2 <- function(genes,center=0){
genes <- toupper(genes)
if(length(genes)==1){
x <- tibble('cluster'=as.numeric(rownames(scaled)),
expression=scaled[[genes]])
} else{
x <- tibble('cluster'=as.numeric(rownames(scaled)),
expression=scaled[,genes] %>% rowSums())
}
x %>% mutate(expression=expression-sum(range(expression))/2-center) %>%
arrange(cluster) %>%
ggplot()+geom_col(aes(cluster,expression,fill=as.factor(cluster)))+
theme(axis.text.x=element_text(angle=90,),legend.position='none')+
scale_x_continuous(breaks=0:40)+
geom_hline(yintercept=0)+
labs(title=genes)
}
dev2(c('il13'),)
library(magrittr)
library(CellaRepertorium)
library(immunarch)
library(tidyverse)
rep1 <- readRDS('data_misc/rep1.rds')
dat <- readRDS('data_misc/dat.rds')
# takes df (already filtered to one set to analyze)
toImmunarch <- function(df){
nTot <- nrow(df)
df <- add_count(df,cdr3)
df[!duplicated(df$cdr3),] %>% select(
Clones=n,
CDR3.nt=cdr3_nt,
CDR3.aa=cdr3,
V.name=v_gene,
D.name=d_gene,
J.name=j_gene,
patient,
timepoint
) %>% mutate(
V.end=NA,
D.start=NA,
D.end=NA,
J.start=NA,
VJ.ins=NA,
VD.ins=NA,
DJ.ins=NA,
Sequence=NA,.after=6) %>%
mutate(Proportion=Clones/nTot,.after=1) %>%
arrange(desc(Clones))
}
# tracks clonotypes across pbmc and til timepoints
trackCl2 <- function(p,...){
require(immunarch)
p <- as.character(p)
temp <- filter(dat@contig_tbl,patient==p) %>%
group_split(timepoint) %>%
map(~toImmunarch(.x))
temp %<>% set_names(filter(dat@contig_tbl,patient==p) %>%
group_by(timepoint) %>% group_keys() %>% unlist())
if(p %in% names(rep1$data)) temp$til <- rep1$data[[p]]
trackClonotypes(temp,...)
}
# Setup: run libraries, root, load rep2
rep2 <- readRDS('data_misc/rep2.rds')
dat <- readRDS('data_misc/dat_healthy.rds')
cl <- readRDS('data_misc/clinical.rds')
cl$sample <- as.character(cl$sample)
# filter out patients without til data
withTils <- rep2$meta %>% filter(timepoint=='til') %>% .$patient
dat@cell_tbl$expTil <- 0
dat@cell_tbl$expPbmc <- 0
#### add data for healthy pbmc level
rep2 <- readRDS('data_misc/rep2_healthy.rds')
rep2$data <- rep2$data[rep2$meta$timepoint=='h']
rep2$meta %<>% filter(timepoint=='h')
map_dbl(rep2$data,nrow) %>% sort()
for(p in rep2$meta$patient %>% unique()){
for(i in c(1,2,8)){
seqs <- rep2$data[[paste0(p,'-h')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,patient==p) %>%
.$barcode %>% unique()
dat@cell_tbl$expPbmc[((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p))] <- i
}}
#### add pem til data
rep2 <- readRDS('data_misc/rep2_healthy.rds')
withTils <- rep2$meta %>% filter(timepoint=='til') %>% .$patient
rep2$data <- rep2$data[rep2$meta$patient %in% withTils]
rep2$meta %<>% filter(patient %in% withTils)
map_dbl(rep2$data,nrow) %>% sort()
for(p in withTils){
for(i in c(1,2,8)){
seqs <- rep2$data[[paste0(p,'-til')]] %>%
filter(Clones>=i) %>% .$CDR3.aa
for(tp in rep2$meta %>% filter(patient==p,timepoint!='til') %>% .$timepoint){
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
dat@cell_tbl$expTil[((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))] <- i
}}}
#### add pem pbmc data
rep2 <- readRDS('data_misc/rep2_healthy.rds')
pem <- rep2$meta %>% filter(timepoint!='h',timepoint!='til') %>% .$patient %>% unique()
rep2$data <- rep2$data[rep2$meta$patient %in% pem]
rep2$meta %<>% filter(patient %in% pem)
map_dbl(rep2$data,nrow) %>% sort()
#### add pem pbmc data
rep2 <- readRDS('data_misc/rep2_healthy.rds')
pem <- rep2$meta %>% filter(!(timepoint %in% c('til','h'))) %>% .$patient %>% unique()
pem
unique(rep2$meta$timepoint)
#### add pem pbmc data
rep2 <- readRDS('data_misc/rep2_healthy.rds')
rep2$data <- rep2$data[rep2$meta$timepoint %in% c('1','3','5')]
rep2$meta %<>% filter(timepoint %in% c('1','3','5'))
rep2$meta
map_dbl(rep2$data,nrow) %>% sort()
rep2$meta %>% filter(patient==7)
rep2$meta %>% filter(patient==7) %>% .$timepoint
for(p in rep2$meta$patient %>% unique()){
for(i in c(1,2,8)){
for(tp in rep2$meta %>% filter(patient==p) %>% .$timepoint){
seqs <- rep2$data[[paste0(p,'-',tp)]] %>%
filter(Clones>=i) %>% .$CDR3.aa
bars <- dat@contig_tbl %>%
filter(cdr3 %in% seqs,timepoint==tp,patient==p) %>%
.$barcode %>% unique()
dat@cell_tbl$expPbmc[((dat@cell_tbl$barcode %in% bars)&
(dat@cell_tbl$patient==p)&
(dat@cell_tbl$timepoint==tp))] <- i
}}}
table(dat@cell_tbl$expPbmc)
table(dat@cell_tbl$expTil)
dat@cell_tbl
saveRDS(dat,'data_misc/dat_healthy.rds')
