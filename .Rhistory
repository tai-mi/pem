ggplot()+geom_col(aes(reorder(cluster,c2),value,fill=cluster))+
theme(axis.text.x=element_text(angle=90,),legend.position='none')+
ylim(c(-1,1))+geom_hline(yintercept=0)
y
}
dev('ccnd3')
dev('cd8a')
gene <- 'cd8a'
gene %<>% toupper()
x <- map(mark,~.x[gene,'avg_log2FC']) %>%
unlist()
x <- ifelse(is.na(x),0,x)
x
y <- mutate(x,c2=str_extract(cluster,'\\d+') %>% as.numeric()) %>%
arrange(c2) %>%
# mutate(cluster=str_extract(value,'\\d+') %>% as.numeric) %>%
ggplot()+geom_col(aes(reorder(cluster,c2),value,fill=cluster))+
theme(axis.text.x=element_text(angle=90,),legend.position='none')+
ylim(c(-1,1))+geom_hline(yintercept=0)
x <- as_tibble(x,rownames='cluster')
x
y <- mutate(x,c2=str_extract(cluster,'\\d+') %>% as.numeric()) %>%
arrange(c2) %>%
# mutate(cluster=str_extract(value,'\\d+') %>% as.numeric) %>%
ggplot()+geom_col(aes(reorder(cluster,c2),value,fill=cluster))+
theme(axis.text.x=element_text(angle=90,),legend.position='none')+
ylim(c(-1,1))+geom_hline(yintercept=0)
y
view(x)
y <- mutate(x,c2=str_extract(cluster,'\\d+') %>% as.numeric())
y
y %>% view()
dev <- function(gene){
gene %<>% toupper()
x <- map(mark,~.x[gene,'avg_log2FC']) %>%
unlist()
x <- ifelse(is.na(x),0,x)
x <- as_tibble(x,rownames='cluster')
y <- mutate(x,c2=str_extract(cluster,'\\d+') %>% as.numeric()) %>%
# mutate(cluster=str_extract(value,'\\d+') %>% as.numeric) %>%
ggplot()+geom_col(aes(reorder(cluster,c2),value,fill=cluster))+
theme(axis.text.x=element_text(angle=90,),legend.position='none')+
ylim(c(-1,1))+geom_hline(yintercept=0)
y
}
dev('cd8b')
y %>% view()
y %>% view()
dev('cd8a')
dev <- function(gene){
gene %<>% toupper()
x <- map(mark,~.x[gene,'avg_log2FC']) %>%
unlist()
x <- ifelse(is.na(x),0,x)
x <- as_tibble(x,rownames='cluster')
y <- mutate(x,c2=str_extract(cluster,'\\d+') %>% as.numeric()) %>%
# mutate(cluster=str_extract(value,'\\d+') %>% as.numeric) %>%
ggplot()+geom_col(aes(reorder(cluster,c2),value,fill=cluster))+
theme(axis.text.x=element_text(angle=90,),legend.position='none')+
ylim(c(min(c(-0.5,x$value)),max(c(0.5,x$value))))+
geom_hline(yintercept=0)
y
}
dev('cd8a')
dev('cd8b')
dev('cd4')
dev('IL2')
dev('CCR3')
dev('CCR4')
dev('CCR5')
dev('CCR6')
dev('CCR10')
dev('il7r')
dev('foxp3')
dev('clec9a')
dev('TRGC')
dev('cd69')
dev('ccr7')
dev('ifng')
dev('tnfa')
dev('cxcr3')
dev('il12rb2')
dev('tbx21')
dev('CD8a')
dev('CD8b')
dev('cd4')
dev('cd3d')
dev('cd3e')
dev('cd3g')
dev('ctla4')
dev('cd38')
dev('foxo4')
dev('tgfb1')
dev('tnf')
dev('il22')
dev('il25')
dev('il26')
dev('il21')
dev('il17')
dev('il17a')
dev('il13')
dev('il10')
dev('PTGDR2')
dev('PECAM1')
dev('itgae')
dev('gzma')
dev('stat4')
dev('stat5')
dev('lef1')
dev('IL7R')
dev('SELL')
dev('PD1')
dev('PDL1')
dev('TOX')
dev('LAG3')
dev('tim3')
dev('tigit')
dev('ki67')
dev('mki67')
dev('cxcr3')
dev('il4')
dev('il5')
dev('il9')
dev('irf4')
dev('ccr4')
dev('gata3')
dev('ccr6')
dev('klrb1')
dev('il17')
dev('irf4')
dev('rorc')
dev('il17a')
dev('il17f')
dev('il17b')
dev('itga1')
dev('cxcr6')
dev('jaml')
dev('itgae')
dev('jaml')
dev('xcl1')
dev('ifng')
dev('HLA-DRA')
dev('HLA-DRB')
dev('HLA-DRB5')
dev('HLA-DRB1')
dev('TBX21')
dev('CD8A')
dev('RORYT')
dev('il23r')
dev('trav24')
dev('trbv11')
dev('fcgr3a')
dev('fcgr3b')
dev('ccr4')
dev('il12rb2')
dev('ccr3')
dev('spi1')
dev('IL17')
dev('IL17A')
dev('IL17B')
dev('IL17F')
dev('TRBV11')
dev('TRAJ18')
dev('TRVA14')
dev('TRJA18')
dev('TRAJ18')
dev('TRAV14')
dev('TRBV8')
dev('TRBV8.2')
dev('TRBV82')
dev('TRBV7')
dev('TRBV2')
dev('KLRB1')
dev('cd56')
dev('ncam1')
library(magrittr)
library(tidyverse)
stuff <- "35105,32291,31213,27492,25060,22267,20052,18650,18456,17122,16507,12946,10796,10134,9133,8758,8704,8591,4967,4725,3524,3336,3247,2966,2965,1706,1639,1248,1228,814,523,319,275,173,162,118" %>%
str_split(',') %>% unlist()
stff
stuff
stuff <- "35105,32291,31213,27492,25060,22267,20052,18650,18456,17122,16507,12946,10796,10134,9133,8758,8704,8591,4967,4725,3524,3336,3247,2966,2965,1706,1639,1248,1228,814,523,319,275,173,162,118" %>%
str_split(',') %>% unlist() %>% as.numeric()
stuff
typeFine <- c('mono14','t','nk','t','t','t','t','t','b','t','t','mono16','t',
't','t','monoint','t','t','j','cdc1','mono','nk','nk','j',
't','j','pdc','b','plasma','j','mono','mono','dc','j','j',
'erythroid')
cellNum <- tibble(type=typeFine,count=stuff)
cellNum
cellNum %>% tail()
cellNum %>% group_by(type) %>% summarise(~sum(.x$count))
cellNum %>% group_by(type) %>% summarise(~nrow(.x))
?summarize
cellNum %>% group_by(type) %>% summarise(n=sum(count))
cellNum <- tibble(type=typeFine,type2=typeCoarse,count=stuff)
cellNum %>% group_by(type2) %>% summarise(n=sum(count))
cellNum <- tibble(type=typeFine,type2=typeCoarse,count=stuff)
cellNum %>% group_by(type2) %>% summarise(n=sum(count))
cellNum
cellNum <- tibble(type=typeFine,type2=typeCoarse,count=stuff)
typeCoarse <- c('mono','t','nk','t','t','t','t','t','b','t','t','mono','t',
't','t','mono','t','t','j','dc','mono','nk','nk','j',
't','j','dc','b','b','j','mono','mono','dc','j','j',
'erythroid')
cellNum <- tibble(type=typeFine,type2=typeCoarse,count=stuff)
cellNum
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=count,fill=type2))
cellNum %>% group_by(type2) %>% summarise(n=sum(count))
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,fill=type2))
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_bar(aes(y=n,fill=type2))
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,x,type2,fill=type2))
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,x=type2,fill=type2))
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,x=type2,fill=type2),position='stack')
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,fill=type2))+
coord_polar()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(y=n,x=0,fill=type2))+
coord_polar()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=n,y=0,fill=type2))+
coord_polar()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=type2,y=n,fill=type2))+
coord_polar()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=n,y=1,fill=type2))+
coord_polar()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=n,y=1,fill=type2))+
coord_polar()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=n,y=1,fill=type2))+
coord_polar('y',start=0)
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=n,y=0,fill=type2))+
coord_polar('y',start=0)
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
theme_minimal()
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
legend(legend=c('b','b','b','b','b','b'))
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
theme(legend.text=element_text(c('a','a','a','a','a','a')))
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(type2!='j') %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
theme(legend.text=element_text(value=c('a','a','a','a','a','a')))
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(c(type2 %in% c('j','erythroid'))) %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)
# cellNum %>% group_by(type2) %>% summarise(n=sum(count)) %>%
#   ggplot()+geom_col(aes(y=n,x=0,fill=type2),position='stack')
cellNum %>% filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2) %>% summarise(n=sum(count)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)
counts <- readRDS('data_sc/cell_source.rds')
counts
library(magrittr)
library(tidyverse)
counts <- readRDS('data_sc/cell_source.rds') %>%
transmute(pem=p,healthy=h+s)
counts
counts %>% pivot_longer()
counts %>% pivot_longer(everything())
counts <- readRDS('data_sc/cell_source.rds') %>%
transmute(pem=p,healthy=h+s) %>%
mutate(fine=typeFine,coarse=typeCoarse)
stuff <- "35105,32291,31213,27492,25060,22267,20052,18650,18456,17122,16507,12946,10796,10134,9133,8758,8704,8591,4967,4725,3524,3336,3247,2966,2965,1706,1639,1248,1228,814,523,319,275,173,162,118" %>%
str_split(',') %>% unlist() %>% as.numeric()
typeFine <- c('mono14','t','nk','t','t','t','t','t','b','t','t','mono16','t',
't','t','monoint','t','t','j','cdc1','mono','nk','nk','platelets',
't','platelets','pdc','b','plasma','j','mono','mono','dc','j','j',
'erythroid')
typeCoarse <- c('mono','t','nk','t','t','t','t','t','b','t','t','mono','t',
't','t','mono','t','t','j','dc','mono','nk','nk','j',
't','j','dc','b','b','j','mono','mono','dc','j','j',
'erythroid')
counts <- readRDS('data_sc/cell_source.rds') %>%
transmute(pem=p,healthy=h+s) %>%
mutate(fine=typeFine,coarse=typeCoarse)
counts
counts <- readRDS('data_sc/cell_source.rds') %>%
transmute(pem=p,healthy=h+s) %>%
mutate(coarse=typeCoarse)
counts %>% pivot_longer(pem,healthy)
counts <- readRDS('data_sc/cell_source.rds') %>%
transmute(pem=p,healthy=h+s) %>%
mutate(coarse=typeCoarse)
counts %>% pivot_longer(pem,healthy)
counts
counts %>% pivot_longer(cols=c(pem,healthy))
counts %>% filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2) %>% summarise(n=sum(count))
counts <- readRDS('data_sc/cell_source.rds') %>%
transmute(pem=p,healthy=h+s) %>%
mutate(type2=typeCoarse)
counts %>% filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2) %>% summarise(n=sum(count))
count
counts
counts %>% pivot_longer(cols=c(pem,healthy))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid')))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(count))
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
ggplot()+geom_col(aes(x=1,y=1,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
group_by(name) %>% summarise(n=n/sum(n))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
group_by(name) %>% summarise(n=n/sum(n)) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
group_by(name) %>% summarise(n=n/sum(n))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
group_by(name) %>% summarise(n=n/sum(n),type2=type2) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
# filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
group_by(name) %>% summarise(n=n/sum(n),type2=type2) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts %>% pivot_longer(cols=c(pem,healthy)) %>%
filter(!(type2 %in% c('j','erythroid'))) %>%
group_by(type2,name) %>% summarise(n=sum(value)) %>%
group_by(name) %>% summarise(n=n/sum(n),type2=type2) %>%
ggplot()+geom_col(aes(x=1,y=n,fill=type2))+
coord_polar('y',start=0)+
facet_wrap(vars(name))
counts <- readRDS('data_sc/cell_orig.rds')
counts
counts %>% names()
names(counts) %<>% str_remove('GEX')
counts %>% names()
cl <- readRDS('data_misc/clinical.rds')
cl
counts <- readRDS('data_sc/cell_orig.rds')
nm <- names(counts)
nm
nm <- names(counts) %>% str_extract('(?<=^PEM)\\d+')
nm
str(cl)
nm <- names(counts) %>% str_extract('(?<=^PEM)\\d+') %>% as.numeric()
nm
cl
nm <- names(counts) %>% str_extract('(?<=^PEM)\\d+') %>% as.numeric() %>%
as_tibble()
nm
nm <- names(counts) %>% str_extract('(?<=^PEM)\\d+') %>% as.numeric() %>%
tibble(patient=.)
nm
cl
left_join(nm,cl,by=c('patient'='sample'))
left_join(nm,cl,by=c('patient'='sample')) %>% na.omit()
nm <- left_join(nm,cl,by=c('patient'='sample'))
nm %>% view()
which(is.na(nm$response))
drop24 <- which(is.na(nm$response))
which(!is.na(nm$response))
drop24 <- which(!is.na(nm$response))
nm <- nm[drop24,]
counts <- counts[,drop24]
dim(counts)
dim(nm)
nm
counts
unique(nm$response)
counts[nm$lynch]
counts[nm$lynch] %>% dim()
df <- counts[nm$lynch]
df
df %<>% mutate(type2=typeCoarse)
df
df <- tibble(value=rowSums(df),type2=typeCoarse) %>%
group_by(type2) %>% summarize(value=sum(value))
df
str(df)
df <- tibble(value=rowSums(df),type2=typeCoarse)
df
df <- counts[nm$lynch]
df <- tibble(value=rowSums(df),type2=typeCoarse) %>%
group_by(type2) %>% summarize(value=sum(value))
df
function(df){
df <- tibble(value=rowSums(df),type2=typeCoarse) %>%
group_by(type2) %>% summarize(value=sum(value)) %>%
filter(!(type2 %in% c('j','erythroid')))
ggplot(df)+geom_col(aes(x=1,y=value,fill=type2))+
coord_polar('y',start=0)
}
piePlot <- function(df){
df <- tibble(value=rowSums(df),type2=typeCoarse) %>%
group_by(type2) %>% summarize(value=sum(value)) %>%
filter(!(type2 %in% c('j','erythroid')))
ggplot(df)+geom_col(aes(x=1,y=value,fill=type2))+
coord_polar('y',start=0)
}
piePlot(counts[nm$lynch])
piePlot(counts[!nm$lynch])
piePlot(counts[nm$response %in% c('CR','PR')])
nm$response %>% unique()
piePlot(counts[nm$response %in% c('PD','SD')])
piePlot(counts[nm$response=='CR'])
piePlot(counts[nm$response=='PR'])
piePlot(counts[nm$response=='SD'])
piePlot(counts[nm$response=='PD'])
