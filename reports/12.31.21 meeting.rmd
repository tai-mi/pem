---
title: "12.31.21 report"
author: "TIM"
date: "12/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F,message=F,warning=F,error=F)
knitr::opts_knit$set(root.dir=normalizePath('..'))
```

```{r initialization, include=F}
source('figures_source.r')
load_tcr()
dat <- load_main('tc')
require(ggprism)
```

### Hill numbers diversity

```{r hill,echo=F}
h2 <- rep4$data[!(names(rep4$data) %in% c('20-5','23-1','21-1'))] #%>% repSample()

h2 <- rbind(repDiversity(h2,'hill',.max.q=2,.min.q=1),
            repDiversity(h2,'hill',.max.q=4,.min.q=4),
            repDiversity(h2,'hill',.max.q=10,.min.q=10),
            repDiversity(h2,'hill',.max.q=50,.min.q=50)) %>% 
  separate(Sample,c('patient','timepoint')) %>% add_clinical()

filter(h2,timepoint %in% c('1','h')) %>%
  group_by(clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='Pretreatment',y='Hill number')
filter(h2,timepoint %in% c('3','5','h')) %>%
  group_by(clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='Posttreatment',y='Hill number')
```

```{r hill downsampled,echo=F}
h2 <- rep4$data[!(names(rep4$data) %in% c('20-5','23-1','21-1'))] %>% 
  repSample('downsample',.prob=T)

h2 <- rbind(repDiversity(h2,'hill',.max.q=2,.min.q=1),
            repDiversity(h2,'hill',.max.q=4,.min.q=4),
            repDiversity(h2,'hill',.max.q=10,.min.q=10),
            repDiversity(h2,'hill',.max.q=50,.min.q=50)) %>% 
  separate(Sample,c('patient','timepoint')) %>% add_clinical()

filter(h2,timepoint %in% c('1','h')) %>%
  group_by(clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='Pretreatment',subtitle='Downsampled',y='Hill number')
filter(h2,timepoint %in% c('3','5','h')) %>%
  group_by(clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='Posttreatment',subtitle='Downsampled',y='Hill number')
```

This is diversity measured by hill number indices where increasing hill number (Q) corresponds with more focus on the largest clonotypes. For example, Q=0 is just the number of clonotypes, Q=1 is shannon index, Q=2 is the inverse simpson index, Q=$\infty$ is 1/(proportion of the largest clone).

-   In pretreatment, Lynch generally has the highest clonality (lowest diversity) through all Q values although when putting more weight on the very largest clonotypes, NLR is similarly clonal indicating that Lynch actually doesn't have higher clonality solely by a few extremely large clonotypes
-   In posttreatment, NLR generally has the highest clonality in higher Q values while Lynch is only slightly more clonal than NR, although the pattern is reversed at Q=1 (shannon-wiener entropy)
-   Healthy always has the highest diversity

#### Misc diversity stuff

```{r hill TM downsampled, echo=F}
# chunk won't display output since include=F
h2 <- rep4$data[rep4$meta$timepoint %in% c('1','3','5')] %>% 
  map(~filter(.x,!is.na(expTil)))
h2 <- h2[map_dbl(h2,~sum(.x$Clones))>100] %>% 
  repSample('downsample',.prob=T)

h2 <- rbind(repDiversity(h2,'hill',.max.q=2,.min.q=1),
            repDiversity(h2,'hill',.max.q=4,.min.q=4),
            repDiversity(h2,'hill',.max.q=10,.min.q=10),
            repDiversity(h2,'hill',.max.q=50,.min.q=50)) %>% 
  separate(Sample,c('patient','timepoint')) %>% add_clinical()

filter(h2,timepoint %in% c('1','h')) %>%
  group_by(clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='Pretreatment TM',subtitle='Downsampled',y='Hill number')
filter(h2,timepoint %in% c('3','5','h')) %>%
  group_by(clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='Posttreatment TM',subtitle='Downsampled',y='Hill number')
```

This is measuring the diversity of the PBMC TIL matching repertoire

-   Pretreatment seems to follow NLR more clonal than L more clonal than NR, but posttreatment L and NR seem similar
-   NLR seems more clonal indicating that the TIL matching clones in the peripheral blood are more expanded both before and after treatment
-   Turnover?

```{r hill TIL downsampled}
h2 <- rep4$data[rep4$meta$timepoint %in% c('0')] %>% 
  repSample('downsample',.prob=T)

h2 <- rbind(repDiversity(h2,'hill',.max.q=2,.min.q=1),
            repDiversity(h2,'hill',.max.q=4,.min.q=4),
            repDiversity(h2,'hill',.max.q=10,.min.q=10),
            repDiversity(h2,'hill',.max.q=50,.min.q=50)) %>% 
  separate(Sample,c('patient','timepoint')) %>% add_clinical()

group_by(h2,clinical,Q) %>%
  summarise(serr=sd(Value)/sqrt(n()),Value=mean(Value)) %>%
  ungroup() %>%
  ggplot(aes(as.factor(Q),Value,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),
            lwd=1)+
  geom_errorbar(aes(ymin=Value-serr,ymax=Value+serr),
                position=position_dodge(width=0.15),
                width=0.1,lwd=1)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='TIL',subtitle='Downsampled',y='Hill number')
```

This is the clonality of the TILs themselves (all pretreatment)

-   NR is most clonal and L is least with NLR somewhere inbetween
-   Clonality delta NR?

### TM prop

```{r TM prop delta, warning=FALSE}
# this is prop seqs not prop clones
h1 <- rep4$data[(rep4$meta$timepoint %in% c(1,3,5))&
                  (!(names(rep4$data) %in% c('20-5','23-1')))]
h1 <- map_dbl(h1,~sum(.x$Clones[!is.na(.x$expTil)])/sum(.x$Clones)) %>%
  set_names(names(h1)) %>% data.frame('prop'=`.`) %>%
  rownames_to_column() %>% separate(rowname,c('patient','timepoint')) %>% 
  add_clinical()
h1 <- pivot_wider(h1,id_cols=patient,names_from=timepoint,values_from=prop) %>% 
  mutate(`3-1`=(`3`-`1`)/`1`,`5-1`=(`5`-`1`)/`1`,`5-3`=(`5`-`3`)/`3`) %>% 
  add_clinical()
plotBoxplot(h1,'5-1') %>% prism()+labs(title='TM prop change 1-5')+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
  geom_hline(yintercept=0)
select(h1,clinical,`5-1`,`3-1`) %>% pivot_longer(-clinical) %>% 
  filter(!is.na(value)) %>% plotBoxplot('value') %>% prism()+
  labs(title='TM prop change pre-post')+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
  geom_hline(yintercept=0)
```

This is change over time in the proportion of peripheral blood cells that have TIL matching TCRs

-   NLR has a greater tendency towards an increase in TIL matching
-   What does this mean when the TILs this is matching to are the pretreatment TILs?
-   Expansion in novel or preexisting TM clones?

### Rarefaction

```{r clinical curves}
# raref curves with error bars for summary of clinical types
clone_curve2 <- function(dfs,margin='seqs',max1=20){
  clone_prop <- function(df,n,margin='seqs'){
    if(margin=='seqs') sum(filter(df,Clones>=n)$Proportion)
    else if(margin=='clones') mean(df$Clones>=n)
    else stop('invalid margin')
  }
  clone_curve <- function(df,margin='seqs',max1=20){
    map_dfr(1:max1,function(i){
      data.frame('n'=i,'prop'=clone_prop(df=df,n=i,margin=margin))
    })
  }
  if(any(class(dfs)=='data.frame')){
    out <- clone_curve(df=dfs,margin=margin,max1=max1) %>% 
      mutate(patient='?',clinical='?',timepoint='?')
  }
  else if(any(class(dfs)=='list')){
    dfs %<>% map(~mutate(.x,Proportion=proportions(Clones)))
    out <- map_dfr(dfs,.id='name',~clone_curve(df=.x,margin=margin,max1=max1)) %>% 
      separate(name,c('patient','timepoint')) %>% add_clinical()
  }
  add_count(out,clinical,n,name='count') %>% 
    group_by(clinical,n) %>%
    summarize(serr=sd(prop)/sqrt(count[1]),prop=mean(prop)) %>% ungroup() %>%
    ggplot(aes(n,prop,color=clinical))+
    geom_point(size=1.25,position=position_dodge(width=0.2))+
    geom_line(aes(group=clinical),position=position_dodge(width=0.2),lwd=0.75)+
    geom_errorbar(aes(ymin=prop-serr,ymax=prop+serr),width=0.2,
                  position=position_dodge(width=0.2))+
    ylim(c(0,1))+
    labs(y=paste('Proportion of',margin),x='Size threshold')
}

clone_curve2(rep4$data[(rep4$meta$timepoint %in% c('1','h'))&
                         (!(names(rep4$data) %in% c('20-5','23-1')))])+
  ggprism::theme_prism()+scale_color_manual(values=cols_clinical)+
  theme(legend.position='none')+labs(title='Pretreatment')
clone_curve2(rep4$data[(rep4$meta$timepoint %in% c('3','5','h'))&
                         (!(names(rep4$data) %in% c('20-5','23-1')))])+
  ggprism::theme_prism()+scale_color_manual(values=cols_clinical)+
  theme(legend.position='none')+labs(title='Posttreatment')
# downsampled
clone_curve2(rep4$data[(rep4$meta$timepoint %in% c('1','h'))&
     (!(names(rep4$data) %in% c('23-1','21-1')))] %>%
       repSample('downsample',.prob=T))+
  ggprism::theme_prism()+scale_color_manual(values=cols_clinical)+
  theme(legend.position='none')+
  labs(title='Pretreatment',subtitle='Downsampled')
clone_curve2(rep4$data[(rep4$meta$timepoint %in% c('3','5','h'))&
                         (!(names(rep4$data) %in% c('20-5')))] %>% repSample('downsample',.prob=T))+
  ggprism::theme_prism()+scale_color_manual(values=cols_clinical)+
  theme(legend.position='none')+
  labs(title='Pretreatment',subtitle='Downsampled')
```

These are just the rarefaction curves from last week:

-   Lynch has much more large clonotypes in pretreatment and more posttreatment (but not as much more). NLR has the second largest general clone sizes followed by NR and then H.
-   Ultimately, most of this is kind of similar to looking at an intermediate to large hill number except more easily interpretable

```{r TIL raref}
# work in progress
h3 <- rep4$data[(rep4$meta$timepoint %in% c(0))]
map(h3,~mutate(.x,Proportion=proportions(Clones))) %>%
  repSample('downsample',.prob=T) %>% 
  clone_curve2(max1=15)+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  labs(title='TIL clonotype size',subtitle='Downsampled')
```

This is specific for TIL clone sizes and as with the hill numbers, NR are much more clonal

### VJ gene stuff
All of these are pretreatment - the first 4 lynch, the next 4 NLR, the last 4 some of the nonresponders

```{r VJ gene usage}
circosSpectra <- function(mask1,ab='b',downsample=F){
  require(circlize)
  vj <- rep4$data[mask1]
  if(downsample) vj <- repSample(vj,'downsample',.prob=T)
  vj <- map_dfr(vj,~.x) %>% 
    select(Proportion,J.name,V.name) %>% 
    filter(str_starts(V.name,paste0('TR',toupper(ab),'V')),
           str_starts(J.name,paste0('TR',toupper(ab),'J'))) %>% 
    na.omit() %>% group_by(J.name,V.name) %>% 
    summarise(total=sum(Proportion))
  temp1 <- vj %>% group_by(V.name) %>% summarise(total=sum(total))
  vj$V.name[vj$V.name %in% temp1$V.name[temp1$total<(sum(temp1$total)/100)]] <- paste0('TR',toupper(ab),'V-other')
  temp1 <- vj %>% group_by(J.name) %>% summarise(total=sum(total))
  vj$J.name[vj$J.name %in% temp1$J.name[temp1$total<(sum(temp1$total)/100)]] <- paste0('TR',toupper(ab),'J-other')
  circos.clear()
  circos.par(gap.degree=0,
             gap.after=c(rep(0.2,length(unique(vj$J.name))-1),5,
                         rep(0.2,length(unique(vj$V.name))-1),5))
  colorFunct <- colorRamp2(
    c(max(vj$total),median(vj$total),min(vj$total)) %>% rev(),
    RColorBrewer::brewer.pal(3,'YlOrRd'),transparency=0.4)
  chordDiagram(vj,annotationTrack='grid',
               preAllocateTracks=1,
               col=colorFunct,link.sort=T)
  circos.trackPlotRegion(track.index = 1,panel.fun = function(x, y){
    sector.name = get.cell.meta.data("sector.index")
    circos.text(CELL_META$xcenter,CELL_META$ylim[1],CELL_META$sector.index,
                facing = "clockwise", niceFacing=T,
                cex=0.7,track.index=1,adj=c(0,0.5))
  }, bg.border = NA)
}

# pretreatment
set.seed(13)
# Lynch
circosSpectra(names(rep4$data)=='6-1','b')
circosSpectra(names(rep4$data)=='2-1','b')
circosSpectra(names(rep4$data)=='14-1','b')
circosSpectra(names(rep4$data)=='5-1','b')
# NLR
circosSpectra(names(rep4$data)=='11-1','b')
circosSpectra(names(rep4$data)=='12-1','b')
circosSpectra(names(rep4$data)=='13-1','b')
circosSpectra(names(rep4$data)=='18-1','b')
# NR
circosSpectra(names(rep4$data)=='10-1','b')
circosSpectra(names(rep4$data)=='15-1','b')
circosSpectra(names(rep4$data)=='16-1','b')
circosSpectra(names(rep4$data)=='17-1','b')
```

Not sure how we want to represent this since there is a lot of variation among the patients. There are expanded L patients as well as one for NR that's pretty expanded, kinda variable.

```{r fourteen point one}
rep4$data$`14-1` %>% arrange(desc(Clones)) %>% head(15) %>% 
  select(CDR3.aa,V.name,J.name,Clones,Proportion,expTil,cluster_fine)
```

Sidenote, the super expanded chord for Lynch-like pretreatment (TRBV9.TRBJ2-2) is all one clonotype from 14-1 which is almost 20% of all cells.

The second most expanded chord though is also from 14-1 (TRBV11-2.TRBJ2-1), but it's mostly three different expanded clonotypes which each differ by only one amino acid (in the same position) and are all expanded in TILs as well.

```{r vj gene diversity}
# seq diversity
limitSize <- 500
h2 <- 'vj' #v.j, j, or v gene diversity
h3 <- c('1','h') #timepoint filter
h1 <- filter(cella@contig_tbl,(!is.na(v_gene))&(!is.na(j_gene)),
             timepoint %in% h3) %>% 
  select(patient,timepoint,v_gene,j_gene) %>% 
  mutate(vj=interaction(v_gene,j_gene)) %>% 
  group_split(patient,timepoint) %>% 
  map_dbl(function(x){
    if(nrow(x)<limitSize) NA_real_
    else{
      if(h2=='v') tab <- table(x$v_gene) %>% as.data.frame() %>% set_colnames(c('gene','freq'))
      if(h2=='j') tab <- table(x$j_gene) %>% as.data.frame() %>% set_colnames(c('gene','freq'))
      if(h2=='vj') tab <- table(x$vj) %>% as.data.frame() %>% set_colnames(c('gene','freq'))
      vegan::diversity(tab$freq,index='simpson')
    }
  }) %>% data.frame('value'=.) %>% mutate(value=1-value)#this makes it clonality
h1 <- filter(cella@contig_tbl,timepoint %in% h3) %>%
  group_by(patient,timepoint) %>% group_keys() %>% 
  cbind(h1) %>% add_clinical()

h3 <- c('3','5','h') #timepoint filter
h4 <- filter(cella@contig_tbl,(!is.na(v_gene))&(!is.na(j_gene)),
             timepoint %in% h3) %>% 
  select(patient,timepoint,v_gene,j_gene) %>% 
  mutate(vj=interaction(v_gene,j_gene)) %>% 
  group_split(patient,timepoint) %>% 
  map_dbl(function(x){
    if(nrow(x)<limitSize) NA_real_
    else{
      if(h2=='v') tab <- table(x$v_gene) %>% as.data.frame() %>% set_colnames(c('gene','freq'))
      if(h2=='j') tab <- table(x$j_gene) %>% as.data.frame() %>% set_colnames(c('gene','freq'))
      if(h2=='vj') tab <- table(x$vj) %>% as.data.frame() %>% set_colnames(c('gene','freq'))
      vegan::diversity(tab$freq,index='simpson')
    }
  }) %>% data.frame('value'=.) %>% mutate(value=1-value)#this makes it clonality
h4 <- filter(cella@contig_tbl,timepoint %in% h3) %>%
  group_by(patient,timepoint) %>% group_keys() %>% 
  cbind(h4) %>% add_clinical()
ggpubr::ggarrange(
  plotErrorbar1(group_by(h1,clinical),'value',T,type=2)+
    labs(title='Pretreatment VJ gene diversity'),
  plotBoxplot(h1,'value') %>% prism()+
    labs(title='Pretreatment VJ gene diversity')+
    theme(legend.pos='none',axis.text.x=element_blank(),
          axis.title.x=element_blank()),
  plotErrorbar1(group_by(h4,clinical),'value',T,type=2)+
    labs(title='Posttreatment VJ gene diversity'),
  plotBoxplot(h4,'value') %>% prism()+
    labs(title='Posttreatment VJ gene diversity')+
    theme(legend.pos='none',axis.text.x=element_blank(),
          axis.title.x=element_blank()),
  nrow=2,ncol=2,widths=c(4,3))
```

The raw VJ gene diversity is not super different and is very skewed especially pretreatment.

### CD4/CD8 specific

Small sidenote: all the points in this section that just have timepoint 1 and 5 - timepoint 5 is a combination of all posttreatment timepoints (3 and 5) that I just labelled 5 for code expediency

```{r clonality raw}
# function to add cd4/cd8 column to df
add_48 <- function(df,col='cluster_fine'){
  mutate(df,cd48=if_else(
    !!rlang::sym(col) %in% c('CD4 Naive','Th2','Treg',
                             'CD4 Early Activated','Th1'),
    'cd4',if_else(
      str_starts(!!rlang::sym(col),'CD8'),'cd8','other'
    )))
}
# generate patientXtimepointXcd48 diversity
h1.2 <- rep4$data[(!(names(rep4$data) %in% c('20-5','23-1')))&
                    (rep4$meta$timepoint %in% c('1','3','5'))] %>% 
  # repSample('downsample') %>%
  map_dfr(function(x){
    map_dfr(c('cd4','cd8','other'),function(y){
      div <- add_48(x) %>% filter(cd48==y) %>% 
        repDiversity('inv.simp') %>% as.numeric()
      data.frame('patient'=x$patient[1],'timepoint'=x$timepoint[1],
                 'type'=y,'value'=log10(div))
    })
  }) %>% add_clinical() %>%
  mutate(timepoint=if_else(timepoint=='3','5',timepoint))
# plotting
group_by(h1.2,clinical,timepoint,type) %>% 
  summarize(serr=sd(value,na.rm=T)/sqrt(sum(!is.na(value))),
            value=mean(value,na.rm=T)) %>% 
  ggplot(aes(timepoint,value,fill=clinical,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),lwd=1)+
  geom_errorbar(aes(ymax=value+serr,ymin=value-serr),width=0.2,lwd=1,
                position=position_dodge(width=0.15))+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  facet_wrap(~type,nrow=3,scales='free')+
  theme(axis.text.x=element_blank())+ylab('Diversity (log inv.simp)')
```

Kinda noisy and not generally approaching significance, but Lynch is generally intermediate with NLR as more clonal for CD8 and NR more clonal for CD4. Not sure how much we can read from this pattern since this masks a lot of the more granular cell types.

```{r CD8 TEMRA clonality downsampled}
h1.2 <- rep4$data[(!(names(rep4$data) %in% c('20-5','23-1')))&
                    (rep4$meta$timepoint %in% c('1','3','5'))] %>% 
  map(~filter(.x,cluster_fine=='CD8 TEMRA'))
h1.2 <- h1.2[map_lgl(h1.2,~sum(.x$Clones)>100)]
h1.2 <- repSample(h1.2,'downsample') %>% repDiversity('inv.simp') %>% 
  separate(Sample,c('patient','timepoint')) %>% add_clinical() %>% 
  mutate(timepoint=if_else(timepoint=='3','5',timepoint),
         value=log10(Value))

group_by(h1.2,clinical,timepoint) %>% 
  summarize(serr=sd(value,na.rm=T)/sqrt(sum(!is.na(value))),
            value=mean(value,na.rm=T)) %>% 
  ggplot(aes(timepoint,value,fill=clinical,color=clinical))+
  geom_point(size=2.5,position=position_dodge(width=0.15))+
  geom_line(aes(group=clinical),position=position_dodge(width=0.15),lwd=1)+
  geom_errorbar(aes(ymax=value+serr,ymin=value-serr),width=0.2,lwd=1,
                position=position_dodge(width=0.15))+
  theme_prism()+scale_color_manual(values=cols_clinical)+
  theme(axis.text.x=element_blank())+
  labs(y='Diversity (log inv.simp)',title='CD8 TEMRA diversity',
       subtitle='Downsampled')
# stochastic, but lynch 1 is generally closer to NR than NLR and L-5 in the middle
```

A bit stochastic, but even with the cell count correction, Lynch like has CD8 TEMRA clonality intermediate between NR and the more clonal NLR. Soooo, Lynch clonality is driven by TEMRA being more clonal and Lynch having more TEMRA, not by Lynch-TEMRA specifically being more clonal.

```{r overall cell proportions}
group_split(add_48(dat),patient,timepoint) %>% 
  map(~table(.x$cd48) %>% as.data.frame() %>% 
        set_names('type',paste0(.x$patient[1],'-',.x$timepoint[1]))) %>% 
  reduce(left_join,by='type') %>% 
  mutate(across(-type,~proportions(replace_na(.x,0)))) %>% 
  pivot_longer(-type,values_to='prop') %>% 
  separate(name,c('patient','timepoint')) %>% 
  filter(!(interaction(patient,timepoint) %in% c('20.5','23.1'))) %>% 
  add_clinical() %>% filter(timepoint!='h') %>% 
  mutate(timepoint=if_else(timepoint=='3','5',timepoint)) %>% 
  plotBoxplot('prop') %>% prism()+facet_grid(type~timepoint)+
  theme(axis.text.x=element_blank())+ggtitle('T cell prop')

h1 <- load_main('ldat') %>% count(patient,timepoint) %>% 
  mutate(name=paste0(patient,'-',timepoint)) %>% select(name,n)
group_split(add_48(dat),patient,timepoint) %>% 
  map(~table(.x$cd48) %>% as.data.frame() %>% 
        set_names('type',paste0(.x$patient[1],'-',.x$timepoint[1]))) %>% 
  reduce(left_join,by='type') %>% 
  pivot_longer(-type,values_to='prop') %>% left_join(h1,by='name') %>% 
  mutate(prop=prop/n) %>% 
  separate(name,c('patient','timepoint')) %>% 
  filter(!(interaction(patient,timepoint) %in% c('20.5','23.1'))) %>% 
  add_clinical() %>% filter(timepoint!='h') %>% 
  mutate(timepoint=if_else(timepoint=='3','5',timepoint)) %>% 
  plotBoxplot('prop') %>% prism()+facet_grid(type~timepoint)+
  theme(axis.text.x=element_blank())+ggtitle('Overall prop')
```

Hard to pick patterns from T cell one - if anything, NLR might be the most distinct with a lower CD8 pre/posttreatment.

From overall, we can much more clearly see the dominance of CD8 in Lynch-like, but it also makes CD4 and other seem somewhat more even.

```{r TM prop}
group_by(add_48(dat),patient,timepoint,cd48) %>% 
  summarize(prop=mean(!is.na(expTil))) %>% add_clinical() %>% 
  ungroup() %>% 
  mutate(timepoint=if_else(timepoint=='3','5',timepoint)) %>% 
  group_by(clinical,timepoint,cd48) %>% 
  summarize(value=mean(prop),serr=sd(prop)/sqrt(n())) %>% 
  filter(clinical!='Healthy') %>% 
  ggplot(aes(clinical,value,fill=clinical,color=clinical)) %>% 
  prism()+geom_col()+
  geom_errorbar(aes(ymax=value+serr,ymin=value-serr),width=0.2,lwd=1)+
  facet_grid(cd48~timepoint,scales='free')+
  theme(axis.text.x=element_blank())+ylab('Proportion tumor matching')
```

NR consistently has lower proportion tumor matching at all timepoints and groups. Lynch has higher CD8 especially pretreatment, less different/interpretable for CD4s.

### Density plots
These are all density plot for all cell types pretreatment. Unlike the nebulosa plots, these are calculated for each patient$x$timepoint combination and then averaged.

![](../figures/density_plots/ldat_l1.png){width="2000"}
*Lynch-like*

![](../figures/density_plots/ldat_nlr1.png){width="2000"}
*NLR*

![](../figures/density_plots/ldat_nr1.png){width="2000"}
*Nonresponder*

Also worth noting is that I haven't normalized the color scaling for these, so the highest cell density for nonresponder is about 0.009 while the highest for NLR and lynch are around 0.013, so the graphs are not currently comparable.