---
title: "NK GSEA"
output: html_document
---

```{r setup, include=FALSE}
#### requires setup chunk from figures_log2.rmd
knitr::opts_chunk$set(echo = F,warning=F,message=F)

source('figures_source.r')
dat <- load_main('ldat')

h1 <- cbind(
  readRDS('data_sc/escape/GOBP_POSITIVE_REGULATION_OF_NATURAL_KILLER_CELL_ACTIVATION.rds') %>% rename(activation=val),
  readRDS('data_sc/escape/GOBP_POSITIVE_REGULATION_OF_NATURAL_KILLER_CELL_CHEMOTAXIS.rds') %>% select(chemotaxis=val),
  readRDS('data_sc/escape/GOBP_POSITIVE_REGULATION_OF_NATURAL_KILLER_CELL_MEDIATED_CYTOTOXICITY.rds') %>% select(cytotoxic=val),
  readRDS('data_sc/escape/GOBP_POSITIVE_REGULATION_OF_NATURAL_KILLER_CELL_MEDIATED_IMMUNE_RESPONSE_TO_TUMOR_CELL.rds') %>% select(tumor_response=val),
  readRDS('data_sc/escape/GOBP_POSITIVE_REGULATION_OF_NATURAL_KILLER_CELL_PROLIFERATION.rds') %>% select(proliferation=val),
  readRDS('data_sc/escape/GOBP_NK_CYTOKINES.rds') %>% select(cytokine=val)
) %>% left_join(select(dat,patient,timepoint,clinical,cluster_fine,barcode),by='barcode') %>% 
  na.omit() %>% select(-barcode) %>% 
  pivot_longer(-c(clinical,patient,timepoint,cluster_fine),names_to='pathway')

plot_main <- function(path1){
  plots <- list()
  #### by patient
  plots[[1]] <- group_by(filter(h1,pathway==path1),patient,timepoint,cluster_fine) %>% 
    summarize(value=mean(value)) %>% add_clinical() %>% 
    group_by(clinical,cluster_fine) %>% summarize(se=sd(value)/sqrt(n()),value=mean(value)) %>% 
    ggplot(aes(cluster_fine,value,fill=clinical)) %>% prism()+
    geom_col(position=position_dodge(width=1))+
    geom_errorbar(aes(ymin=value-se,ymax=value+se),width=0.2,lwd=1.2,
                  position=position_dodge(width=1))
  
  # timepoint split by patient
  plots[[2]] <- group_by(filter(h1,pathway==path1),patient,timepoint,cluster_fine) %>% 
    summarize(value=mean(value)) %>% add_clinical() %>% filter(clinical!='Healthy') %>% 
    ggplot(aes(timepoint,value,fill=clinical)) %>% prism()+
    stat_summary(fun=mean, geom = "bar",position=position_dodge(width=1)) +
    stat_summary(fun.data = mean_se, geom = "errorbar",width=0.2,position=position_dodge(width=1))+
    facet_wrap(~cluster_fine)
  
  # timepoint propotional change split by patient by comparison
  h2 <- group_by(filter(h1,pathway==path1),patient,timepoint,cluster_fine) %>% 
    summarize(value=mean(value)) %>% add_clinical() %>% filter(clinical!='Healthy') %>% 
    pivot_wider(id_cols=c(patient,cluster_fine),names_from=timepoint,values_from=value) %>% 
    mutate(d13=(`3`-`1`)/`1`,d15=(`5`-`1`)/`1`,d35=(`5`-`3`)/`3`) %>% add_clinical()
  plots[[3]] <- gridExtra::grid.arrange(
    ggplot(h2,aes(cluster_fine,d13,fill=clinical)) %>% prism()+
      geom_hline(yintercept=0)+geom_boxplot()+
      ylab('Prop change timepoint 1-3')+theme(legend.position='none'),
    ggplot(h2,aes(cluster_fine,d35,fill=clinical)) %>% prism()+
      geom_hline(yintercept=0)+geom_boxplot()+
      ylab('Prop change timepoint 3-5'),
    ggplot(h2,aes(cluster_fine,d15,fill=clinical)) %>% prism()+
      geom_hline(yintercept=0)+geom_boxplot()+
      ylab('Prop change timepoint 1-5')+theme(legend.position='none'),
    nrow=2,widths=c(1,1.5)
  )
  plots
}
```

### Intro

```{r}
ggplot(h1,aes(clinical,value)) %>% prism()+geom_violin(aes(fill=clinical))+
  facet_wrap(~pathway)+theme(axis.text.x=element_blank())
```

This shows the distribution of GSEA scores for the various NK gene sets analyzed

```{r}
ggplot(h1,aes(value,color=pathway))+geom_density(adjust=0.5)
```

There is a significant degree of quantization in the scores output especially for chemotaxis, but also for proliferation and tumor specific response all of which are only 6-7 gene sets. Cytotoxicity and activation are more normally distributed and each have \>20 genes.

### Positive regulation of activation

```{r activation}
plot_main('activation')
```

There appears to be a pattern towards an average spike in NK activation at timepoint 3 for NLR and NR which fades by timepoint 5 which is not present for Lynch. However, individual trajectories do not replicate this pattern for NR, and thre are only two individuals with timepoint 3 for NLR.

General pattern of increasing CD16 NK activation in lynch with a generally decreasing/stable signature in NLR/NR - and CD16 is the dominant effector NK cell cluster.

### Positive regulation of cytotoxicity

```{r}
plot_main('cytotoxic')
```

There is a general trend of higher cytotoxicity signatures in NR overall followed by NLR then lynch (which is noticeably lower than even healthy). This pattern generally holds across timepoints with a pattern of a spike in cytotoxicity at timepoint 3 with timepoint 5 still having higher cytotoxicity than timepoint one across all clinical groups (on average).

Maybe this is nonresponders failing to develop an adaptive response and instead having short lived control or regression mediated by cytotoxic NK whereas this response is not as noticeable in the other clinical types, and the difference between cytotoxic NK signatures of NLR and NR grows between timepoint 1 and 5

### Positive regulation of proliferation

```{r}
plot_main('proliferation')
```

Proliferative signature broadly looks highest in healthy - indicative of less dysfunction/stress?

Honestly, all the error bars and spreads are so large that a lot of this seems questionably interpretable, but it does seem like CD16 lynch increases in proliferative signature while the others decrease. NLR seems higher overall in CD16 proliferation though.

CD56 is the broadly more progenitor-like population and seems like L and NLR have initially higher values while L is the only one that shows notable increase 1-5 in proliferative CD56 signature.

### NK mediated tumor cytotoxicity

```{r}
plot_main('tumor_response')
```

Although the proportional changes are rather variable (as are the timepoint values), there does seem to be generally higher antitumor cytotoxic signature in NR in both subtypes across all timepoints especially timepoint 5.

Hard to really discern any strong temporal trend. Also worth noting that this gene set is just 7 genes and thus a bit questionable.

### NK chemotaxis

```{r}
plot_main('chemotaxis')
```

Not really strong trends or patterns here. Also this gene set may refer to genes other cell types express to chemoattract NK cells rather than chemokines released by NK cells themselves.

### Exhaustion signature

Was reading some stuff on NK cell dysfunctional states and hypothesized that maybe increasing NK cell dysfunction over time leads to loss of control in NR, but wasn't really the case. Lynch had lower rate of exhausted CD16 NK at timepoints 3/5, and NLR had higher exhaustion rates for timepoints 3/5 (as well as timepoint 3 for CD56), but the pattern doesn't look all that conclusive (and timepoint 3 is weak timepoint for NLR).

![](figures/nk_custom_signatures/exhaustion_timepoint.png)

For reference, the figure is in figures_gsea on the cluster since it's a thresholded percentage feature set of PD1, KLRG1, LAG3, TIM3, and TIGIT.

### NK Cytokines

```{r}
h2 <- h1
h1 %<>% filter(cluster_fine=='CD16 NK')
plot_main('cytokine')
h1 <- h2
rm(h2)
```

This is a custom gene set of IFNG, CCL1-5, CXCL8, GM-CSF, TNF, and IL5/10/13. CD56 NK are excluded from visualization because scores for all patients are around or below 0 (and one point is messing up the scale for the change over time graph).

Overall, there don't seem to be major differences among the clinical types except that all are generally higher than healthy and maybe experience an increase from 1-3 and decrease from 3-5.
